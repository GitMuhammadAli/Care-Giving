#!/bin/bash
# =============================================================================
# CareCircle - Pre-Commit Hook
# =============================================================================
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
# Or: ln -sf ../../scripts/pre-commit .git/hooks/pre-commit
#
# This hook runs before each commit to:
# 1. Check for secrets in staged files
# 2. Run lint on staged TypeScript/JavaScript files
# 3. Validate branch naming convention
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}Running pre-commit checks...${NC}"
echo ""

# =============================================================================
# Check 1: Secrets Detection
# =============================================================================
echo -e "${YELLOW}[1/3] Checking for secrets...${NC}"

# Patterns that might indicate secrets
SECRET_PATTERNS=(
    "password\s*=\s*['\"][^'\"]+['\"]"
    "api_key\s*=\s*['\"][^'\"]+['\"]"
    "secret\s*=\s*['\"][^'\"]+['\"]"
    "token\s*=\s*['\"][^'\"]+['\"]"
    "-----BEGIN.*PRIVATE KEY-----"
    "AKIA[0-9A-Z]{16}"  # AWS Access Key
)

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

HAS_SECRETS=false
for file in $STAGED_FILES; do
    # Skip example files and test files
    if [[ "$file" == *".example"* ]] || [[ "$file" == *".test."* ]] || [[ "$file" == *".spec."* ]]; then
        continue
    fi
    
    # Skip binary files
    if [[ "$file" == *.png ]] || [[ "$file" == *.jpg ]] || [[ "$file" == *.ico ]]; then
        continue
    fi
    
    # Check each pattern
    for pattern in "${SECRET_PATTERNS[@]}"; do
        if git show ":$file" 2>/dev/null | grep -qiE "$pattern"; then
            # Check if it's a placeholder
            if ! git show ":$file" | grep -qiE "(your-|placeholder|example|xxx|change-me|TODO)"; then
                echo -e "${RED}  ⚠ Potential secret found in $file${NC}"
                HAS_SECRETS=true
            fi
        fi
    done
done

if [ "$HAS_SECRETS" = true ]; then
    echo -e "${RED}  ✗ Potential secrets detected! Please review the files above.${NC}"
    echo -e "${YELLOW}  Use 'git diff --cached' to see what's being committed.${NC}"
    echo ""
    echo -e "${YELLOW}  To bypass this check (not recommended):${NC}"
    echo -e "${YELLOW}    git commit --no-verify${NC}"
    exit 1
fi

echo -e "${GREEN}  ✓ No secrets detected${NC}"

# =============================================================================
# Check 2: Lint Staged Files
# =============================================================================
echo -e "${YELLOW}[2/3] Running lint on staged files...${NC}"

# Get staged TypeScript/JavaScript files
TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -n "$TS_FILES" ]; then
    # Run lint only if pnpm is available
    if command -v pnpm &> /dev/null; then
        # Check if eslint exists
        if pnpm list eslint &> /dev/null; then
            echo "$TS_FILES" | xargs pnpm eslint --max-warnings=0 2>/dev/null || {
                echo -e "${RED}  ✗ Lint errors found. Please fix them before committing.${NC}"
                echo -e "${YELLOW}  Run 'pnpm lint --fix' to auto-fix some issues.${NC}"
                exit 1
            }
            echo -e "${GREEN}  ✓ Lint passed${NC}"
        else
            echo -e "${YELLOW}  ⚠ ESLint not found, skipping lint check${NC}"
        fi
    else
        echo -e "${YELLOW}  ⚠ pnpm not found, skipping lint check${NC}"
    fi
else
    echo -e "${GREEN}  ✓ No TypeScript/JavaScript files to lint${NC}"
fi

# =============================================================================
# Check 3: Branch Naming Convention
# =============================================================================
echo -e "${YELLOW}[3/3] Checking branch naming...${NC}"

BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# Skip check for main/develop branches
if [ "$BRANCH_NAME" = "main" ] || [ "$BRANCH_NAME" = "develop" ] || [ "$BRANCH_NAME" = "master" ]; then
    echo -e "${GREEN}  ✓ Protected branch: $BRANCH_NAME${NC}"
else
    # Check branch naming pattern
    VALID_PATTERNS="^(feature|fix|hotfix|bugfix|chore|docs|refactor|test|release|ci|devops)/"
    
    if [[ ! "$BRANCH_NAME" =~ $VALID_PATTERNS ]]; then
        echo -e "${YELLOW}  ⚠ Branch name '$BRANCH_NAME' doesn't follow convention${NC}"
        echo -e "${YELLOW}    Expected: feature/*, fix/*, hotfix/*, chore/*, docs/*, etc.${NC}"
        # Warning only, don't block
    else
        echo -e "${GREEN}  ✓ Branch naming OK: $BRANCH_NAME${NC}"
    fi
fi

# =============================================================================
# All Checks Passed
# =============================================================================
echo ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}  ✓ All pre-commit checks passed!${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

exit 0

