version: '3.8'

services:
  # Database Backup Service
  backup:
    build:
      context: .
      dockerfile: docker/backup/Dockerfile
    container_name: carecircle-backup
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - BACKUP_BUCKET=${BACKUP_BUCKET}
      - BACKUP_RETENTION=${BACKUP_RETENTION:-30}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
    volumes:
      - ./backups:/backups
      - ./scripts:/scripts:ro
    networks:
      - carecircle-network
    depends_on:
      - postgres
    # Run once and exit (for manual backups)
    # For scheduled backups, use cron on host or K8s CronJob
    restart: "no"

  # Restore Service (one-time use)
  restore:
    build:
      context: .
      dockerfile: docker/backup/Dockerfile
    container_name: carecircle-restore
    environment:
      - DATABASE_URL=${DATABASE_URL}
    volumes:
      - ./backups:/backups
      - ./scripts:/scripts:ro
    networks:
      - carecircle-network
    depends_on:
      - postgres
    entrypoint: ["restore-database"]
    restart: "no"
    profiles:
      - restore  # Only run when explicitly requested

networks:
  carecircle-network:
    external: true
