name: Deploy to Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository }}

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push images
        run: |
          # Build and tag images
          docker buildx build --platform linux/amd64 \
            -t ${{ env.IMAGE_PREFIX }}/api:staging-${{ github.sha }} \
            -t ${{ env.IMAGE_PREFIX }}/api:staging-latest \
            -f apps/api/Dockerfile \
            --push .

          docker buildx build --platform linux/amd64 \
            -t ${{ env.IMAGE_PREFIX }}/web:staging-${{ github.sha }} \
            -t ${{ env.IMAGE_PREFIX }}/web:staging-latest \
            -f apps/web/Dockerfile \
            --build-arg NEXT_PUBLIC_API_URL=${{ secrets.STAGING_API_URL }} \
            --push .

          docker buildx build --platform linux/amd64 \
            -t ${{ env.IMAGE_PREFIX }}/workers:staging-${{ github.sha }} \
            -t ${{ env.IMAGE_PREFIX }}/workers:staging-latest \
            -f apps/workers/Dockerfile \
            --push .

      - name: Deploy to Staging Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/carecircle
            
            # Pull latest images
            docker pull ${{ env.IMAGE_PREFIX }}/api:staging-latest
            docker pull ${{ env.IMAGE_PREFIX }}/web:staging-latest
            docker pull ${{ env.IMAGE_PREFIX }}/workers:staging-latest
            
            # Update docker-compose with new images
            docker-compose -f docker-compose.staging.yml up -d --no-build
            
            # Run database migrations
            docker-compose -f docker-compose.staging.yml exec -T api npx prisma migrate deploy
            
            # Clean up old images
            docker image prune -f

      - name: Health Check
        run: |
          sleep 30
          curl -f ${{ secrets.STAGING_API_URL }}/health || exit 1
          curl -f ${{ secrets.STAGING_WEB_URL }} || exit 1
          echo "âœ… Staging deployment successful!"

      - name: Notify on Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          fields: repo,message,commit,author,action,eventName,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

